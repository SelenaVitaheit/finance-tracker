<div class="container-fluid mt-4">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–∞—Ç–∞ -->
  <div class="row mb-4">
    <div class="col">
      <h1 class="display-6">üìä –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
      <p class="text-muted">
        <%= Date.current.strftime('%A, %d %B %Y') %> ‚Ä¢ 
        –û–±–Ω–æ–≤–ª–µ–Ω–æ: <%= Time.current.strftime('%H:%M') %>
      </p>
    </div>
    <div class="col-auto">
      <div class="btn-group">
        <%= link_to 'üí∏ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', transactions_path, class: 'btn btn-outline-primary' %>
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
          üìÖ –ü–µ—Ä–∏–æ–¥
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#">–°–µ–≥–æ–¥–Ω—è</a></li>
          <li><a class="dropdown-item" href="#">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</a></li>
          <li><a class="dropdown-item" href="#">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</a></li>
          <li><a class="dropdown-item" href="#">–≠—Ç–æ—Ç –≥–æ–¥</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-start border-primary border-4 shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                –î–æ—Ö–æ–¥—ã (–≤—Å–µ –≤—Ä–µ–º—è)
              </div>
              <div class="h5 mb-0 fw-bold text-gray-800">
                <%= format_money(@total_income, 'income') %>
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-arrow-up-circle text-primary fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-start border-danger border-4 shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-danger text-uppercase mb-1">
                –†–∞—Å—Ö–æ–¥—ã (–≤—Å–µ –≤—Ä–µ–º—è)
              </div>
              <div class="h5 mb-0 fw-bold text-gray-800">
                <%= format_money(@total_expense, 'expense') %>
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-arrow-down-circle text-danger fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-start border-success border-4 shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-success text-uppercase mb-1">
                –ë–∞–ª–∞–Ω—Å
              </div>
              <div class="h5 mb-0 fw-bold text-gray-800">
                <%= format_money(@balance) %>
              </div>
              <div class="mt-2 mb-0 text-muted">
                <span class="<%= @balance >= 0 ? 'text-success' : 'text-danger' %>">
                  <i class="bi bi-<%= @balance >= 0 ? 'arrow-up' : 'arrow-down' %> me-1"></i>
                  <%= @balance >= 0 ? '–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π' : '–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π' %>
                </span>
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-cash-stack text-success fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-start border-info border-4 shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-info text-uppercase mb-1">
                –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
              </div>
              <div class="h5 mb-0 fw-bold text-gray-800">
                <%= @transaction_count %>
              </div>
              <div class="mt-2 mb-0 text-muted">
                <span class="me-2">üìã –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</span>
                <span class="me-2">üè∑Ô∏è <%= @category_count %> –∫–∞—Ç.</span>
                <span>üéØ <%= @goal_count %> —Ü–µ–ª–µ–π</span>
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-graph-up text-info fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–µ—Ç–∞–ª–∏ -->
  <div class="row">
    <!-- –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º -->
    <div class="col-xl-8 col-lg-7 mb-4">
      <div class="card shadow h-100">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 fw-bold text-primary">–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h6>
          <small class="text-muted">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤</small>
        </div>
        <div class="card-body">
          <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≥—Ä–∞—Ñ–∏–∫ Chart.js -->
          <div id="monthlyChartContainer" style="position: relative; height: 300px;">
            <canvas id="monthlyChart"></canvas>
          </div>
          
          <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ (—Å–∫—Ä—ã—Ç–∞) -->
          <div id="chartData" style="display: none;">
            <%= @monthly_stats.to_json.html_safe %>
          </div>
        </div>
      </div>
    </div>

    <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
    <div class="col-xl-4 col-lg-5 mb-4">
      <div class="card shadow h-100">
        <div class="card-header py-3">
          <h6 class="m-0 fw-bold text-danger">–¢–æ–ø —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h6>
        </div>
        <div class="card-body">
          <% if @expenses_by_category.any? %>
            <!-- –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
            <div id="expensesChartContainer" style="position: relative; height: 200px;">
              <canvas id="expensesChart"></canvas>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
            <div class="mt-4">
              <% @expenses_by_category.each do |cat| %>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <span class="badge bg-danger me-2">üè∑Ô∏è</span>
                    <%= cat[:name] %>
                  </div>
                  <div class="fw-bold">
                    <%= format_money(cat[:total], 'expense') %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-pie-chart text-muted fs-1"></i>
              <p class="text-muted mt-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: —Ü–µ–ª–∏ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
  <div class="row">
    <!-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏ -->
    <div class="col-xl-5 col-lg-6 mb-4">
      <div class="card shadow h-100">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 fw-bold text-warning">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏</h6>
          </div>
        <div class="card-body">
          <% if @goals.any? %>
            <% @goals.each do |goal| %>
              <div class="card mb-3">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0"><%= goal.title %></h6>
                    <span class="badge bg-<%= goal.completed? ? 'success' : 'warning' %>">
                      <%= goal.completed? ? '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' %>
                    </span>
                  </div>
                  
                  <div class="mb-2">
                    <%= progress_bar(goal.progress_percentage) %>
                  </div>
                  
                  <div class="row">
                    <div class="col">
                      <small class="text-muted">–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞:</small>
                      <div class="fw-bold"><%= format_money(goal.current_amount) %></div>
                    </div>
                    <div class="col">
                      <small class="text-muted">–¶–µ–ª—å:</small>
                      <div class="fw-bold"><%= format_money(goal.target_amount) %></div>
                    </div>
                    <div class="col">
                      <small class="text-muted">–û—Å—Ç–∞–ª–æ—Å—å:</small>
                      <div class="fw-bold <%= goal.amount_remaining > 0 ? 'text-danger' : 'text-success' %>">
                        <%= format_money(goal.amount_remaining) %>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mt-2 text-muted small">
                    <i class="bi bi-calendar me-1"></i>
                    –°—Ä–æ–∫: <%= format_date(goal.deadline) %> 
                    (<%= goal.days_remaining %> –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å)
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-flag text-muted fs-1"></i>
              <p class="text-muted mt-2">–¶–µ–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</p>
              <p class="small">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
    <div class="col-xl-7 col-lg-6 mb-4">
      <div class="card shadow h-100">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 fw-bold text-info">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h6>
          <%= link_to '–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí', transactions_path, class: 'btn btn-sm btn-outline-info' %>
        </div>
        <div class="card-body p-0">
          <% if @recent_transactions.any? %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th class="text-end">–°—É–º–º–∞</th>
                  </tr>
                </thead>
                <tbody>
                  <% @recent_transactions.each do |transaction| %>
                    <tr>
                      <td><small><%= format_date(transaction.date) %></small></td>
                      <td>
                        <span class="badge bg-<%= transaction.category&.category_type == 'income' ? 'success' : 'danger' %>">
                          <%= transaction.category&.name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' %>
                        </span>
                      </td>
                      <td>
                        <%= truncate(transaction.description, length: 30) %>
                      </td>
                      <td class="text-end fw-bold <%= transaction.transaction_type == 'income' ? 'text-success' : 'text-danger' %>">
                        <%= transaction.display_amount %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-receipt text-muted fs-1"></i>
              <p class="text-muted mt-2">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
              <%= link_to '–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é', new_transaction_path, class: 'btn btn-sm btn-primary' %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
  <div class="row mt-4">
    <div class="col">
      <div class="card shadow">
        <div class="card-body text-center">
          <h6 class="card-title mb-3">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h6>
          <div class="btn-group" role="group">
            <%= link_to '‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥', new_transaction_path(type: 'income'), 
                class: 'btn btn-outline-success' %>
            <%= link_to '‚ûñ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥', new_transaction_path(type: 'expense'), 
                class: 'btn btn-outline-danger' %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- –ò–∫–æ–Ω–∫–∏ Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<!-- –°—Ç–∏–ª–∏ –¥–ª—è dashboard -->
<style>
  .card {
    border-radius: 0.5rem;
  }
  
  .card-header {
    border-bottom: 1px solid rgba(0,0,0,.125);
    background-color: rgba(0,0,0,.02);
  }
  
  .border-start {
    border-left-width: 0.25rem !important;
  }
  
  .shadow {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
  }
  
  .text-xs {
    font-size: 0.7rem;
  }
  
  .text-gray-800 {
    color: #5a5c69;
  }
</style>

<!-- JavaScript –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
  const monthlyStats = JSON.parse(document.getElementById('chartData').textContent);
  
  // 1. –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º
  if (monthlyStats.length > 0 && document.getElementById('monthlyChart')) {
    const monthlyLabels = monthlyStats.map(stat => stat.month_short);
    const incomeData = monthlyStats.map(stat => stat.incomes);
    const expenseData = monthlyStats.map(stat => stat.expenses);
    
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
      type: 'bar',
      data: {
        labels: monthlyLabels,
        datasets: [
          {
            label: '–î–æ—Ö–æ–¥—ã',
            data: incomeData,
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1
          },
          {
            label: '–†–∞—Å—Ö–æ–¥—ã',
            data: expenseData,
            backgroundColor: 'rgba(220, 53, 69, 0.7)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ${context.raw.toLocaleString('ru-RU')} ‚ÇΩ`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
              }
            }
          }
        }
      }
    });
  }
  
  // 2. –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  const expensesByCategory = <%= @expenses_by_category.to_json.html_safe %>;
  if (expensesByCategory.length > 0 && document.getElementById('expensesChart')) {
    const expenseLabels = expensesByCategory.map(cat => cat.name);
    const expenseData = expensesByCategory.map(cat => cat.total);
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤
    const expenseColors = [
      '#dc3545', '#fd7e14', '#ffc107', '#20c997', '#0dcaf0',
      '#6f42c1', '#e83e8c', '#6610f2', '#198754', '#0d6efd'
    ];
    
    const expensesCtx = document.getElementById('expensesChart').getContext('2d');
    new Chart(expensesCtx, {
      type: 'doughnut',
      data: {
        labels: expenseLabels,
        datasets: [{
          data: expenseData,
          backgroundColor: expenseColors.slice(0, expenseData.length),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((context.raw / total) * 100);
                return `${context.label}: ${context.raw.toLocaleString('ru-RU')} ‚ÇΩ (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }
});
</script>